Day 2 Lecture - Windows ADS and Registery

Windows Registery uses hive keys "HKEY_" to organze the registery
we can use the registery to establish persistence in a windows machine


Using the HKEY_CLASSES_ROOT key we can manipulate the registery to allow us to get through windows defender
HKEY_USER
s-1-5-18 - System
s-1-5-19 - Service
s-1-5-20 - Network

The registery resides in memory if the system loses power it won't be the same when you reboot the machine
if you are trying to establish persistance you have to store your backdoor somewhere such as ntuser.dat

Creating an Alternate Data Stream on a file
C:\windows\system32>echo social security numbers > reminder.txt:secret.info 

C:\windows\system32>dir reminder.txt 
 Directory of C:\windows\system32
 02/27/2021 07:13 PM                  23 reminder.txt
                 1 File(s)            23 bytes
                 0 Dir(s) 20,060,712,960 bytes free

C:\windows\system32>type reminder.txt 
Always try your best

Viewing an Alternate Data Stream on a file.
C:\windows\system32>more < reminder.txt:secret.info 
social security numbers

C:\windows\system32>notepad reminder.txt:secret.info 

C:\windows\system32>dir /R reminder.txt 
 Directory of C:\windows\system32
 02/27/2021 07:13 PM                   23 reminder.txt
                                       26 reminder.txt:secret.info:$DATA
                1 File(s)              23 bytes
                0 Dir(s)   20,060,557,312 bytes free

C:\windows\system32>type reminder.txt:secret.info 
The filename, directory name, or volume label syntax is incorrect.

To recursivly search for a file with Alternate Data Stream
Get-ChildItem C:\Users\CTF\ -Recurse | ForEach-Object { get-item $_.fullname -Stream * } | 
where { $_.stream -ne ':$DATA' }



Lecture Day 3 Linux------------------------------------------------------------------------------------------------------------------------------
creating a config file to enable easier SSH
create .ssh/config file
edit the file as follows:
Host linops
    HostName 10.50.28.138
    User student
    Port 22
Create an alias in bash_aliases file
alias sshlinops='ssh linops -X terminator&' - this allows you to ssh and open a terminator shell in the background
source .bashrc
Then generate an ssh key
ssh-keygen
then copy your key over 
ssh-copy-id sshlinops

Lecture start
When getting onto a machine
Where am I? hostname or uname -a
Who am I? whoami /id
What am I allowed to do? sudo -l
What's going on? w/who and ps -elf
Why is that happening? (Process Validity: later date fill in)
How is that happening? 
What's in the file? 

Machine background
/bin (/usr/bin or /usr/local/bin) - on some machines bin applications are found in /usr/bin or /usr/local/bin instead of /bin
- Binarys this is going to be a lot of the application files

/sbin (/usr/sbin) - System Binarys
- requires sudo to use these

/home - current users home directory

/usr
- some binarys
- documentations
- example files for certain applications
- catch all for any files that are used system wide

/etc - Everything that's configurable
- catch all for all of the configuration files that are system level

/var
- Things that are likely to change such as log files

/boot - Directory read at boot
- This is where the GRUB and its config files are as well as the bootloaders

/dev - devices 
- headphones
- keyboards
- mice
- data streams stdin, stdout, stderr
- where the harddrive can be found (sda)

/lib - The library
- functions are kept here.
- similar to a windows .dll

/media - removable media like a flash drive or a cd

/mnt - reserved for permeantly attachted external storage

/opt - Optional add on applications and their files

/root - Home directory for the root user

/run - runtime and variable data: mounted at boot and is designed to hold data for that instance of the system running

/tmp - Temporary files: Everyone has access to tmp, nothing stays here it is a good place for temporary sustained access

/proc - processes

Important Files------------------------------------
/etc/shadow

/etc/passwd
username:passhold:gid:uid:comments:home dir:default shell
/etc/group
Groupname:password:gid:grouplist

File Information------------------------------------
ls -lisa
reading a directory listing
permissions: filetype,user{3},group{3},others{3}

suid - when this file is executed is executed like the owner is doing it
sgid - when the file executing is ran it runs as if the group member was running it
stickybit - when the sticky bit is set only the file owner can delete the file

Python3 - CTFd

Lecture Day 4 Windows Boot Process---------------------------------------------------------------------------------

BIOS - 
MBR
 - points to the boot manager(bootmgr)
   bootmgr allows you to pick how you want the system to boot
Windows Boot Manager
 - Points to the Boot Configuration Data Store (BCD)
BCD
 - Points to the OS loader
OS Loader
 - winload.exe
      - Like a cold start. It takes the operating system longer to get started
      - However Windows10 has an option auto selected called fast boot that uses winresume however with this option selected it only 
        stores the OS's state nothing else. It is like a glorified sleep state. There is a downside to this winexplorer i.e. the file
        system needs to turn all the way off in order to be effecient.
 -winresume.exe
      -winresume.exe is used for hibernation. It takes the state of ram (everything thats going on at the time) and writes it to a file
       doing this allows the system to read the .sys file that the ram state was stored in. Allows for a faster boot up and restores where you are


UEFI

GPT - GUID Partition Table
 - UEFI doesn't check for the GPT it checks with the bootmgrfw.efi to see if the GPT exists and if so where it is. 

UEFI Boot Manager
 - Tells UEFI where to find the GPT as well as where the BCD is.
 
BootLoader
-BIOS
  - NTLDR.exe was used for Kernel 5 which was windows 7 however boot.ini which is used with this is editable in a text editor making this very unsecure.
  - Bootmgr.exe is for Kernel 6+ 
-UEFI
  - Bootmgrfw.efi is Kernel 6+, UEFI requires at least kernel 6 to be used 

Kernels
-Legacy Kernel 5 (Boot.ini)
    - Boots straight to NTOSKRNL
-Kernel 6+ (BCD)
    - Goes to Winload.exe/Winresume.exe or Winload.efi/Winresume.efi then onto the NTOSKRNL
    

NTOSKRNL
- Loads the following: Pagefile.sys, Loads Device Drivers, Load directory Hive, HAL.dll, and Process Manager; Process Manager launches System Idle Process
- It also starts SMSS.exe (Master sessions Manager)

SMSS.exe - relies on a dll called terminal services.
- Launches two sessions to start its process
    - Session 0 (This is system level privilieges)
        - Launches CSRSS.exe(Session 0)
        - Also launches WININT.exe(Session 0)
            - WININT launches the following in session 0
                - LSASS.exe
                - SVCHOST.exe
    - Session 1 (This is user level privilieges)
        - Launches CSRSS.exe (Session 1)
        - WINLOGON.exe(Session 1)
            - WINLOGON launches the following in Session 1
                - LOGONUI.exe
                - USERINIT.exe
                    - USERINIT also launches Explorer.exe once explorer.exe is launched USERINT kills itself
                        - Explorer.exe is what we interface with when using the windows system


BDCEDIT
from cmd
    - Type C:\Windows\Panther\setupact.log | findstr /i "detect boot enviroment"
    - We can also bcdedit | findstr /i winload or winresume
        - If we see one or the other we can see how the system was started
    - You can also use the GUI msinfo32
- When using bcdedit command when looking for the active boot information you need to look for the identifier with the value {current}. Everything else is slightly irrelevant but can be useful. 















































